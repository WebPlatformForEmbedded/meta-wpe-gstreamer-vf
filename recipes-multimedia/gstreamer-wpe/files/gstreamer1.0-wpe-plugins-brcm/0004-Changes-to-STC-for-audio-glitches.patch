From 929c2b74a15a72204f4c58cf2f4c84649aedd90e Mon Sep 17 00:00:00 2001
From: krp97 <k.plata576@gmail.com>
Date: Fri, 23 Jul 2021 10:26:33 +0000
Subject: [PATCH 4/5] Changes to STC for audio glitches

---
 reference/audiodecode/src/gst_brcm_audio_decoder.c | 4 ++++
 reference/util/src/gst_system_clock.c              | 1 +
 reference/videodecode/src/gst_brcm_video_decoder.c | 1 +
 3 files changed, 6 insertions(+)

diff --git a/reference/audiodecode/src/gst_brcm_audio_decoder.c b/reference/audiodecode/src/gst_brcm_audio_decoder.c
index 8b2df24..2a95a3a 100755
--- a/reference/audiodecode/src/gst_brcm_audio_decoder.c
+++ b/reference/audiodecode/src/gst_brcm_audio_decoder.c
@@ -473,6 +473,10 @@ static void gst_brcm_audio_decoder_init(GstBrcmAudioDecoder *decoder) {
     settings.primary.fifoUnderflow.context = decoder;
     settings.secondary.streamStatusAvailable.callback = pt_status_available_cb;
     settings.secondary.streamStatusAvailable.context = decoder;
+    
+    settings.primary.discardThreshold = 6000;
+    settings.secondary.discardThreshold = 6000;
+    settings.description.discardThreshold = 6000;
 
     settings.primary.ptsError.callback = pts_error_cb;
     settings.primary.ptsError.context = decoder;
diff --git a/reference/util/src/gst_system_clock.c b/reference/util/src/gst_system_clock.c
index 117307e..e12712b 100755
--- a/reference/util/src/gst_system_clock.c
+++ b/reference/util/src/gst_system_clock.c
@@ -61,6 +61,7 @@ static void gst_brcm_system_clock_get_stc_channel(unsigned int token_id){
 
     NEXUS_SimpleStcChannel_GetDefaultSettings(&stcSettings);
     stcSettings.mode = NEXUS_StcChannelMode_eAuto;
+    stcSettings.modeSettings.Auto.behavior = NEXUS_StcChannelAutoModeBehavior_eAudioMaster;
     sysclock.clock[token_id].stc_channel = NEXUS_SimpleStcChannel_Create(&stcSettings);
     BDBG_ASSERT(sysclock.clock[token_id].stc_channel);
 
diff --git a/reference/videodecode/src/gst_brcm_video_decoder.c b/reference/videodecode/src/gst_brcm_video_decoder.c
index 5655f2f..5f219d4 100755
--- a/reference/videodecode/src/gst_brcm_video_decoder.c
+++ b/reference/videodecode/src/gst_brcm_video_decoder.c
@@ -2009,6 +2009,7 @@ static GstStateChangeReturn gst_brcm_video_decoder_change_state(GstElement *elem
 #if (SCANMODE_SUPPORTED)
         settings.scanMode = NEXUS_VideoDecoderScanMode_e1080p;
 #endif
+        settings.discardThreshold = 6000 * 45000;
         settings.fifoEmpty.callback = cdb_underflow_cb;
         settings.fifoEmpty.context = decoder;
         settings.firstPtsPassed.callback = first_pts_pass_cb;
-- 
2.7.4

